# path: k8s/ingress.yaml
# version: 2.0

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: chatbot-ingress-test-fingerprint
  annotations:
    kubernetes.io/ingress.class: nginx
    
    # Enable optional client certificate verification without CA validation
    # Client can connect without certificate, but if certificate is presented, it will be captured
    nginx.ingress.kubernetes.io/auth-tls-verify-client: "optional_no_ca"
    nginx.ingress.kubernetes.io/auth-tls-secret: "chatbot/client-ca-secret"
    nginx.ingress.kubernetes.io/auth-tls-verify-depth: "1"
    nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream: "false"
    
    # Pass client certificate fingerprint (SHA1) to backend
    # Note: SHA256 not available in NGINX Ingress Controller v1.14.1
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_set_header X-Client-Cert-Fingerprint $ssl_client_fingerprint;
      proxy_set_header X-Client-Cert-DN $ssl_client_s_dn;
      proxy_set_header X-Client-Cert-Verify $ssl_client_verify;
    
    # Proxy settings
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
spec:
  tls:
    - hosts:
        - "*.kube.local"
      secretName: server-tls-secret
  rules:
    # =================================================================
    # PUBLIC SERVICE - No client certificate required
    # =================================================================
    
    # Main application (frontend + backend via Caddy)
    - host: chat.kube.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: caddy-service
                port:
                  number: 3000
    
    # =================================================================
    # ADMIN SERVICES - Require whitelisted client certificate fingerprint
    # =================================================================
    
    # MinIO Console (requires whitelisted machine certificate)
    - host: chat-minio.kube.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: caddy-service
                port:
                  number: 3000
    
    # n8n Workflow Automation (requires whitelisted machine certificate)
    - host: chat-n8n.kube.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: caddy-service
                port:
                  number: 3000
    
    # ArangoDB Web UI (requires whitelisted machine certificate)
    - host: chat-db.kube.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: caddy-service
                port:
                  number: 3000