# path: k8s/caddy/configmap.yaml
# version: 2.0
# Caddy reverse proxy configuration with client certificate fingerprint verification
# Changes in v2.0:
# - Activated fingerprint verification for admin services (minio, n8n, arango)
# - Public service (chat.kube.local) remains accessible without certificate
# - Admin services require whitelisted client certificate fingerprint

apiVersion: v1
kind: ConfigMap
metadata:
  name: caddy-config
  namespace: chatbot
data:
  Caddyfile: |
    {
        auto_https off
    }
    
    # ===========================================================================
    # Default / Fallback - Handles probes and chat.kube.local traffic
    # PUBLIC ACCESS - No client certificate required
    # ===========================================================================
    :3000 {
        handle /health {
            respond "OK" 200
        }
        
        handle /api/* {
            reverse_proxy backend-service:8000
        }
        
        handle {
            reverse_proxy frontend-service:3000
        }
    }
    
    # ===========================================================================
    # Public service - chat.kube.local
    # PUBLIC ACCESS - No client certificate required
    # ===========================================================================
    http://chat.kube.local:3000 {
        handle /api/* {
            reverse_proxy backend-service:8000
        }
        
        handle {
            reverse_proxy frontend-service:3000
        }
    }
    
    # ===========================================================================
    # Admin services - Require whitelisted machine certificate fingerprint
    # PROTECTED ACCESS - Client certificate fingerprint verification enabled
    # ===========================================================================
    
    # MinIO Console - minio.kube.local
    http://minio.kube.local:3000 {
        @allowed_fingerprints {
            # IMPORTANT: Use SHA1 format from NGINX (lowercase, no colons)
            # Example: 7214738db7c8dd74ba12aadd3ec47b1da0c96418
            # To add your fingerprint, replace YOUR_FINGERPRINT_HERE below
            # or use: ./scripts/whitelist-fingerprint.sh <certificate-file>
            header X-Client-Cert-Fingerprint "7214738db7c8dd74ba12aadd3ec47b1da0c96418"
        }

        handle @allowed_fingerprints {
            reverse_proxy minio-service:9001
        }

        handle {
            respond "403 Forbidden - Machine not authorized
Access to MinIO Console requires a whitelisted client certificate.
Your fingerprint: {http.request.header.X-Client-Cert-Fingerprint}
Certificate DN: {http.request.header.X-Client-Cert-DN}
Certificate verify: {http.request.header.X-Client-Cert-Verify}
" 403
        }
    }

    # n8n Workflow Automation - n8n.kube.local
    http://n8n.kube.local:3000 {
        @allowed_fingerprints {
            # IMPORTANT: Use SHA1 format from NGINX (lowercase, no colons)
            # Example: 7214738db7c8dd74ba12aadd3ec47b1da0c96418
            header X-Client-Cert-Fingerprint "7214738db7c8dd74ba12aadd3ec47b1da0c96418"
        }

        handle @allowed_fingerprints {
            reverse_proxy n8n-service:5678
        }

        handle {
            respond "403 Forbidden - Machine not authorized
Access to n8n requires a whitelisted client certificate.
Your fingerprint: {http.request.header.X-Client-Cert-Fingerprint}
Certificate DN: {http.request.header.X-Client-Cert-DN}
Certificate verify: {http.request.header.X-Client-Cert-Verify}
" 403
        }
    }

    # ArangoDB Web UI - arango.kube.local
    http://arango.kube.local:3000 {
        @allowed_fingerprints {
            # IMPORTANT: Use SHA1 format from NGINX (lowercase, no colons)
            # Example: 7214738db7c8dd74ba12aadd3ec47b1da0c96418
            header X-Client-Cert-Fingerprint "7214738db7c8dd74ba12aadd3ec47b1da0c96418"
        }

        handle @allowed_fingerprints {
            reverse_proxy arangodb-service:8529
        }

        handle {
            respond "403 Forbidden - Machine not authorized
Access to ArangoDB Web UI requires a whitelisted client certificate.
Your fingerprint: {http.request.header.X-Client-Cert-Fingerprint}
Certificate DN: {http.request.header.X-Client-Cert-DN}
Certificate verify: {http.request.header.X-Client-Cert-Verify}
" 403
        }
    }